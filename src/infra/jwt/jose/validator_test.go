package jose

import (
	"context"
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
)

func TestValidator(t *testing.T) {
	cfg := NewConfig("https://consensys.eu.auth0.com/", []string{"https://quorum-key-manager.consensys.net/admin"}, "", "", time.Minute)
	validator, _ := New(cfg)
	ctx := context.Background()

	t.Run("should validate token successfully", func(t *testing.T) {
		token := "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6InZxd3gwNm9ueEFMN1dSeGFGMXd5eiJ9.eyJodHRwczovL2FwaS5vcmNoZXN0cmF0ZS5uZXR3b3JrIjp7InRlbmFudF9pZCI6ImFkbWluIn0sImlzcyI6Imh0dHBzOi8vY29uc2Vuc3lzLmV1LmF1dGgwLmNvbS8iLCJzdWIiOiJLZHpYV2FDcFFaUGEwNERQdENtN3dqR0lUY1VyZ3VycEBjbGllbnRzIiwiYXVkIjoiaHR0cHM6Ly9xdW9ydW0ta2V5LW1hbmFnZXIuY29uc2Vuc3lzLm5ldC9hZG1pbiIsImlhdCI6MTY0Mjc0MzM2MywiZXhwIjoxNjQyODI5NzYzLCJhenAiOiJLZHpYV2FDcFFaUGEwNERQdENtN3dqR0lUY1VyZ3VycCIsInNjb3BlIjoiKjoqIiwiZ3R5IjoiY2xpZW50LWNyZWRlbnRpYWxzIn0.KvM_CV1UCfweIUMwWzuxM_f8DB8cOTHENaSGcQOdWcscFOyfJzr4syN-Icc1KoHOo3OYOpZF_I9nIq86M485OdzvoC7mq_V2tB7HUetuC-k2gjXzZ3qs8NhSKufd79joBtzuP5kr8Dpo5mKM8qbFYhoQMEAi-lWW6pnarifCKy6ou651w5i__hNcmPCSwZBEodH3WT1Es8Tgv3WmI_9ithbKBPPB87xpf65hDnq_w1jORhEF9lD291rgvcuDy1VoTeWiyAS4_Gh70TAKjxMzpzt8JN8TbSnDR54UDs0eaJMDxgOQLnreKwQYI34n0MO2xFNMuzAE1dc3JurxKeCuag"

		claims, err := validator.ValidateToken(ctx, token)
		assert.NoError(t, err)
		assert.Equal(t, "KdzXWaCpQZPa04DPtCm7wjGITcUrgurp@clients", claims.Tenant)
		assert.Equal(t, []string{"*:*"}, claims.Permissions)
	})

	t.Run("should fail to validate token due to AUD", func(t *testing.T) {
		token := "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6InZxd3gwNm9ueEFMN1dSeGFGMXd5eiJ9.eyJodHRwczovL2FwaS5vcmNoZXN0cmF0ZS5uZXR3b3JrIjp7InRlbmFudF9pZCI6InF1b3J1bS1rZXktbWFuYWdlci5jb25zZW5zeXMubmV0In0sImlzcyI6Imh0dHBzOi8vY29uc2Vuc3lzLmV1LmF1dGgwLmNvbS8iLCJzdWIiOiJLZHpYV2FDcFFaUGEwNERQdENtN3dqR0lUY1VyZ3VycEBjbGllbnRzIiwiYXVkIjoiaHR0cHM6Ly9xdW9ydW0ta2V5LW1hbmFnZXIuY29uc2Vuc3lzLm5ldCIsImlhdCI6MTY0Mjc0Nzc3NiwiZXhwIjoxNjQyODM0MTc2LCJhenAiOiJLZHpYV2FDcFFaUGEwNERQdENtN3dqR0lUY1VyZ3VycCIsInNjb3BlIjoicmVhZDoqIiwiZ3R5IjoiY2xpZW50LWNyZWRlbnRpYWxzIn0.OtmY0Nr3PnsqxNR-80X5NC-4kg32WqTnX6uwcpOX4ldPd9LBeUWFziwOqqGf8F-JETo9JgVKfNrWbfpQ5PwZhiSZjHNslMQ3zd6gzz1O-GXHKdYSsvzMpHplQvLYTKTkIU4ToDW6mbN-hXqqm7U64ygfVf3-7URIIkDhVJEp0wZgyVKkC7ZiO4xUOORNUPI0pQzd8D3EfYMPp2v4H7vXvtUxbHTEeVzyTo7wnoAXgYbpbW3LhAoJsDtsmyng8qaX99NSFEINv6CupmC2lnn1HFjOzmRtXbRmImUNn2jKlgFkLwI8DsSWFSQmgJUpLrNSk-SKAS-O_Hy--72tKjo-qw"

		_, err := validator.ValidateToken(ctx, token)
		assert.Error(t, err)
	})

	t.Run("should fail to validate token due to ISS", func(t *testing.T) {
		token := "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ik4wSXdNRE13TVRReVJrSkRSVFJDUXpNd00wSTRNemt3UVRsQlF6TTNRMFJET1RnME56ZEJPUSJ9.eyJodHRwczovL2FwaS5jb2RlZmkubmV0d29yayI6eyJ0ZW5hbnRJZCI6InRlbmFudElkMSIsImVudGl0eUlkIjoiZW50aXR5SWQxIn0sImh0dHBzOi8vYXBpLm9yY2hlc3RyYXRlLm5ldHdvcmsiOnsidGVuYW50X2lkIjoidGVuYW50SWQxOmVudGl0eUlkMSJ9LCJpc3MiOiJodHRwczovL2NvZGVmaS5ldS5hdXRoMC5jb20vIiwic3ViIjoiYXV0aDB8NjE1YzU5NmRiZTM3ODQwMDcxOTA0NDc4IiwiYXVkIjpbImh0dHBzOi8vYXBpLmNvZGVmaS5uZXR3b3JrIiwiaHR0cHM6Ly9jb2RlZmkuZXUuYXV0aDAuY29tL3VzZXJpbmZvIl0sImlhdCI6MTY0Mjc0MzgyNywiZXhwIjoxNjQyODMwMjI3LCJhenAiOiJFRk1HamdNU3pTMUx2aER3Z2RmZHdvVWFYUGdlbDdvOCIsInNjb3BlIjoib3BlbmlkIHByb2ZpbGUgZW1haWwiLCJndHkiOiJwYXNzd29yZCIsInBlcm1pc3Npb25zIjpbImFjY2VwdDppbnN0cnVjdGlvbiIsImFwcHJvdmU6ZGlnaXRhbC1jdXJyZW5jeSIsImJ1cm46ZGlnaXRhbC1jdXJyZW5jeSIsImJ1cm46dG9rZW4iLCJjcmVhdGVfYWxsOmVudGl0eTphZG1pbiIsImNyZWF0ZV9hbGw6dGVuYW50OmFkbWluIiwiY3JlYXRlOmVudGl0eSIsImNyZWF0ZTplbnRpdHk6YWRtaW4iLCJjcmVhdGU6ZW50aXR5Om1lbWJlciIsImNyZWF0ZTpzdGFjazphZG1pbiIsImNyZWF0ZTp0ZW5hbnQiLCJjcmVhdGU6dGVuYW50OmFkbWluIiwiZGVsZXRlX2FsbDplbnRpdHkiLCJkZWxldGVfYWxsOmVudGl0eTptZW1iZXIiLCJkZWxldGVfYWxsOnRlbmFudCIsImRlbGV0ZTpkYXRhIiwiZGVsZXRlOmVudGl0eSIsImRlbGV0ZTpvcmFjbGUiLCJkZWxldGU6c2NoZW1hIiwiZGVsZXRlOnRlbmFudCIsImRlbGV0ZTp1c2VyIiwiZGVwbG95OmRpZ2l0YWwtY3VycmVuY3kiLCJkZXBsb3k6dG9rZW4iLCJkZXBvc2l0OmRpZ2l0YWwtY3VycmVuY3kiLCJleGVjOnRva2VuIiwiZXhlY3V0ZWhvbGQ6Y29uZmlkZW50aWFsdG9rZW4iLCJleGVjdXRlSG9sZDpkaWdpdGFsLWN1cnJlbmN5IiwiZXhlY3V0ZWhvbGQ6dG9rZW4iLCJob2xkOmNvbmZpZGVudGlhbHRva2VuIiwiaG9sZDpkaWdpdGFsLWN1cnJlbmN5IiwiaG9sZDp0b2tlbiIsIm1pbnQ6Y29uZmlkZW50aWFsdG9rZW4iLCJtaW50OmRpZ2l0YWwtY3VycmVuY3kiLCJtaW50OnRva2VuIiwicmVhZGFsbDpkaWdpdGFsLWN1cnJlbmN5LW9wZXJhdGlvbnMiLCJyZWFkX2FsbDplbnRpdHkiLCJyZWFkX2FsbDplbnRpdHk6bWVtYmVyIiwicmVhZF9hbGw6dGVuYW50IiwicmVhZDphdHRlc3RhdGlvbiIsInJlYWQ6YmFsYW5jZS1oaXN0b3J5IiwicmVhZDpjYXNoLWFjY291bnQiLCJyZWFkOmNoYW5uZWwiLCJyZWFkOmNvbmZpZGVudGlhbHRva2VuIiwicmVhZDpkYXRhIiwicmVhZDpkaWdpdGFsLWN1cnJlbmN5IiwicmVhZDpkaWdpdGFsLWN1cnJlbmN5LWhvbGRlcnMiLCJyZWFkOmRpZ2l0YWwtY3VycmVuY3ktb3BlcmF0aW9ucyIsInJlYWQ6ZW50aXR5IiwicmVhZDppbnN0cnVjdGlvbiIsInJlYWQ6bGVnYWwtZW50aXR5IiwicmVhZDpub3RpZmljYXRpb24iLCJyZWFkOm9yYWNsZSIsInJlYWQ6c2NoZW1hIiwicmVhZDp0ZW5hbnQiLCJyZWFkOnRva2VuIiwicmVhZDp1c2VyIiwicmVqZWN0Omluc3RydWN0aW9uIiwicmVsZWFzZUhvbGQ6ZGlnaXRhbC1jdXJyZW5jeSIsInNldF91cmk6dG9rZW4iLCJ0cmFuc2ZlcjpkaWdpdGFsLWN1cnJlbmN5IiwidHJhbnNmZXJGcm9tOmRpZ2l0YWwtY3VycmVuY3kiLCJ0cmFuc2Zlcjp0b2tlbiIsInVwZGF0ZV9hbGw6ZW50aXR5IiwidXBkYXRlX2FsbDplbnRpdHk6bWVtYmVyIiwidXBkYXRlX2FsbDp0ZW5hbnQiLCJ1cGRhdGU6ZGF0YSIsInVwZGF0ZTplbnRpdHkiLCJ1cGRhdGU6b3JhY2xlIiwidXBkYXRlOnRlbmFudCIsInVwZGF0ZTp1c2VyIiwid2l0aGRyYXc6ZGlnaXRhbC1jdXJyZW5jeSIsIndyaXRlOmFjY291bnQiLCJ3cml0ZTphdHRlc3RhdGlvbiIsIndyaXRlOmF6dGVjYWNjb3VudCIsIndyaXRlOmNhc2gtYWNjb3VudCIsIndyaXRlOmNoYW5uZWwiLCJ3cml0ZTpjb25maWRlbnRpYWx0b2tlbiIsIndyaXRlOmRhdGEiLCJ3cml0ZTpvcGVyYXRpb25zX3JlcXVlc3QiLCJ3cml0ZTpvcGVyYXRpb25zX3Jlc29sdmUiLCJ3cml0ZTpvcmFjbGUiLCJ3cml0ZTpzY2hlbWEiLCJ3cml0ZTp0ZW5hbnQiXX0.g6oF9-oC0WWsNbbmd2-aXLQ0_SquMyzBOi0FXpxSnOzDRRTqZkKX-siGJf2N0A0msvtWKjefXPXZ8mBaqKNi4HkgryGvmmz-x96cP97E7BIlVT9LZET8hK94vvbkHUxWrlJiGQ1nub8aeQufUA62AyFVhi6bMOgarKew4pg1t0LJP3DWOpogegGQT2d_3THO4-D4sIZcoPuyoUm8zpBn5jm-usGPc0C9gLcH-ht6tKAnl0_LonL3XU86s1h264BWmUGsgz3yZ_vMPbchaRtsC6-pvELTQwNLnN67CzAp3_axt9Q1eqb3GF6lnMlyibNnFZec0ClvIKzOrb33sNNctA"

		_, err := validator.ValidateToken(ctx, token)
		assert.Error(t, err)
	})

	t.Run("should fail to validate token due to invalid", func(t *testing.T) {
		token := "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6InZxd3gwNm9ueEFMN1dSeGFGMXd5eiJ9eyJodHRwczovL2FwaS5jb2RlZmkubmV0d29yayI6eyJ0ZW5hbnRJZCI6InRlbmFudElkMSIsImVudGl0eUlkIjoiZW50aXR5SWQxIn0sImh0dHBzOi8vYXBpLm9yY2hlc3RyYXRlLm5ldHdvcmsiOnsidGVuYW50X2lkIjoidGVuYW50SWQxOmVudGl0eUlkMSJ9LCJpc3MiOiJodHRwczovL2NvZGVmaS5ldS5hdXRoMC5jb20vIiwic3ViIjoiYXV0aDB8NjE1YzU5NmRiZTM3ODQwMDcxOTA0NDc4IiwiYXVkIjpbImh0dHBzOi8vYXBpLmNvZGVmaS5uZXR3b3JrIiwiaHR0cHM6Ly9jb2RlZmkuZXUuYXV0aDAuY29tL3VzZXJpbmZvIl0sImlhdCI6MTY0Mjc0MzgyNywiZXhwIjoxNjQyODMwMjI3LCJhenAiOiJFRk1HamdNU3pTMUx2aER3Z2RmZHdvVWFYUGdlbDdvOCIsInNjb3BlIjoib3BlbmlkIHByb2ZpbGUgZW1haWwiLCJndHkiOiJwYXNzd29yZCIsInBlcm1pc3Npb25zIjpbImFjY2VwdDppbnN0cnVjdGlvbiIsImFwcHJvdmU6ZGlnaXRhbC1jdXJyZW5jeSIsImJ1cm46ZGlnaXRhbC1jdXJyZW5jeSIsImJ1cm46dG9rZW4iLCJjcmVhdGVfYWxsOmVudGl0eTphZG1pbiIsImNyZWF0ZV9hbGw6dGVuYW50OmFkbWluIiwiY3JlYXRlOmVudGl0eSIsImNyZWF0ZTplbnRpdHk6YWRtaW4iLCJjcmVhdGU6ZW50aXR5Om1lbWJlciIsImNyZWF0ZTpzdGFjazphZG1pbiIsImNyZWF0ZTp0ZW5hbnQiLCJjcmVhdGU6dGVuYW50OmFkbWluIiwiZGVsZXRlX2FsbDplbnRpdHkiLCJkZWxldGVfYWxsOmVudGl0eTptZW1iZXIiLCJkZWxldGVfYWxsOnRlbmFudCIsImRlbGV0ZTpkYXRhIiwiZGVsZXRlOmVudGl0eSIsImRlbGV0ZTpvcmFjbGUiLCJkZWxldGU6c2NoZW1hIiwiZGVsZXRlOnRlbmFudCIsImRlbGV0ZTp1c2VyIiwiZGVwbG95OmRpZ2l0YWwtY3VycmVuY3kiLCJkZXBsb3k6dG9rZW4iLCJkZXBvc2l0OmRpZ2l0YWwtY3VycmVuY3kiLCJleGVjOnRva2VuIiwiZXhlY3V0ZWhvbGQ6Y29uZmlkZW50aWFsdG9rZW4iLCJleGVjdXRlSG9sZDpkaWdpdGFsLWN1cnJlbmN5IiwiZXhlY3V0ZWhvbGQ6dG9rZW4iLCJob2xkOmNvbmZpZGVudGlhbHRva2VuIiwiaG9sZDpkaWdpdGFsLWN1cnJlbmN5IiwiaG9sZDp0b2tlbiIsIm1pbnQ6Y29uZmlkZW50aWFsdG9rZW4iLCJtaW50OmRpZ2l0YWwtY3VycmVuY3kiLCJtaW50OnRva2VuIiwicmVhZGFsbDpkaWdpdGFsLWN1cnJlbmN5LW9wZXJhdGlvbnMiLCJyZWFkX2FsbDplbnRpdHkiLCJyZWFkX2FsbDplbnRpdHk6bWVtYmVyIiwicmVhZF9hbGw6dGVuYW50IiwicmVhZDphdHRlc3RhdGlvbiIsInJlYWQ6YmFsYW5jZS1oaXN0b3J5IiwicmVhZDpjYXNoLWFjY291bnQiLCJyZWFkOmNoYW5uZWwiLCJyZWFkOmNvbmZpZGVudGlhbHRva2VuIiwicmVhZDpkYXRhIiwicmVhZDpkaWdpdGFsLWN1cnJlbmN5IiwicmVhZDpkaWdpdGFsLWN1cnJlbmN5LWhvbGRlcnMiLCJyZWFkOmRpZ2l0YWwtY3VycmVuY3ktb3BlcmF0aW9ucyIsInJlYWQ6ZW50aXR5IiwicmVhZDppbnN0cnVjdGlvbiIsInJlYWQ6bGVnYWwtZW50aXR5IiwicmVhZDpub3RpZmljYXRpb24iLCJyZWFkOm9yYWNsZSIsInJlYWQ6c2NoZW1hIiwicmVhZDp0ZW5hbnQiLCJyZWFkOnRva2VuIiwicmVhZDp1c2VyIiwicmVqZWN0Omluc3RydWN0aW9uIiwicmVsZWFzZUhvbGQ6ZGlnaXRhbC1jdXJyZW5jeSIsInNldF91cmk6dG9rZW4iLCJ0cmFuc2ZlcjpkaWdpdGFsLWN1cnJlbmN5IiwidHJhbnNmZXJGcm9tOmRpZ2l0YWwtY3VycmVuY3kiLCJ0cmFuc2Zlcjp0b2tlbiIsInVwZGF0ZV9hbGw6ZW50aXR5IiwidXBkYXRlX2FsbDplbnRpdHk6bWVtYmVyIiwidXBkYXRlX2FsbDp0ZW5hbnQiLCJ1cGRhdGU6ZGF0YSIsInVwZGF0ZTplbnRpdHkiLCJ1cGRhdGU6b3JhY2xlIiwidXBkYXRlOnRlbmFudCIsInVwZGF0ZTp1c2VyIiwid2l0aGRyYXc6ZGlnaXRhbC1jdXJyZW5jeSIsIndyaXRlOmFjY291bnQiLCJ3cml0ZTphdHRlc3RhdGlvbiIsIndyaXRlOmF6dGVjYWNjb3VudCIsIndyaXRlOmNhc2gtYWNjb3VudCIsIndyaXRlOmNoYW5uZWwiLCJ3cml0ZTpjb25maWRlbnRpYWx0b2tlbiIsIndyaXRlOmRhdGEiLCJ3cml0ZTpvcGVyYXRpb25zX3JlcXVlc3QiLCJ3cml0ZTpvcGVyYXRpb25zX3Jlc29sdmUiLCJ3cml0ZTpvcmFjbGUiLCJ3cml0ZTpzY2hlbWEiLCJ3cml0ZTp0ZW5hbnQiXX0.g6oF9-oC0WWsNbbmd2-aXLQ0_SquMyzBOi0FXpxSnOzDRRTqZkKX-siGJf2N0A0msvtWKjefXPXZ8mBaqKNi4HkgryGvmmz-x96cP97E7BIlVT9LZET8hK94vvbkHUxWrlJiGQ1nub8aeQufUA62AyFVhi6bMOgarKew4pg1t0LJP3DWOpogegGQT2d_3THO4-D4sIZcoPuyoUm8zpBn5jm-usGPc0C9gLcH-ht6tKAnl0_LonL3XU86s1h264BWmUGsgz3yZ_vMPbchaRtsC6-pvELTQwNLnN67CzAp3_axt9Q1eqb3GF6lnMlyibNnFZec0ClvIKzOrb33sNNctA"

		_, err := validator.ValidateToken(ctx, token)
		assert.Error(t, err)
	})
}

func TestValidator_CustomClaims(t *testing.T) {
	cfg := NewConfig("https://codefi.eu.auth0.com/", []string{"https://api.codefi.network"}, "https://api.orchestrate.network", "permissions", time.Minute)
	validator, _ := New(cfg)
	ctx := context.Background()

	t.Run("should validate token successfully", func(t *testing.T) {
		token := "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ik4wSXdNRE13TVRReVJrSkRSVFJDUXpNd00wSTRNemt3UVRsQlF6TTNRMFJET1RnME56ZEJPUSJ9.eyJodHRwczovL2FwaS5jb2RlZmkubmV0d29yayI6eyJ0ZW5hbnRJZCI6InRlbmFudElkMSIsImVudGl0eUlkIjoiZW50aXR5SWQxIn0sImh0dHBzOi8vYXBpLm9yY2hlc3RyYXRlLm5ldHdvcmsiOnsidGVuYW50X2lkIjoidGVuYW50SWQxOmVudGl0eUlkMSJ9LCJpc3MiOiJodHRwczovL2NvZGVmaS5ldS5hdXRoMC5jb20vIiwic3ViIjoiYXV0aDB8NjE1YzU5NmRiZTM3ODQwMDcxOTA0NDc4IiwiYXVkIjpbImh0dHBzOi8vYXBpLmNvZGVmaS5uZXR3b3JrIiwiaHR0cHM6Ly9jb2RlZmkuZXUuYXV0aDAuY29tL3VzZXJpbmZvIl0sImlhdCI6MTY0Mjc1MjE2OCwiZXhwIjoxNjQyODM4NTY4LCJhenAiOiJFRk1HamdNU3pTMUx2aER3Z2RmZHdvVWFYUGdlbDdvOCIsInNjb3BlIjoib3BlbmlkIHByb2ZpbGUgZW1haWwiLCJndHkiOiJwYXNzd29yZCIsInBlcm1pc3Npb25zIjpbImFjY2VwdDppbnN0cnVjdGlvbiIsImFwcHJvdmU6ZGlnaXRhbC1jdXJyZW5jeSIsImJ1cm46ZGlnaXRhbC1jdXJyZW5jeSIsImJ1cm46dG9rZW4iLCJjcmVhdGVfYWxsOmVudGl0eTphZG1pbiIsImNyZWF0ZV9hbGw6dGVuYW50OmFkbWluIiwiY3JlYXRlOmVudGl0eSIsImNyZWF0ZTplbnRpdHk6YWRtaW4iLCJjcmVhdGU6ZW50aXR5Om1lbWJlciIsImNyZWF0ZTpzdGFjazphZG1pbiIsImNyZWF0ZTp0ZW5hbnQiLCJjcmVhdGU6dGVuYW50OmFkbWluIiwiZGVsZXRlX2FsbDplbnRpdHkiLCJkZWxldGVfYWxsOmVudGl0eTptZW1iZXIiLCJkZWxldGVfYWxsOnRlbmFudCIsImRlbGV0ZTpkYXRhIiwiZGVsZXRlOmVudGl0eSIsImRlbGV0ZTpvcmFjbGUiLCJkZWxldGU6c2NoZW1hIiwiZGVsZXRlOnRlbmFudCIsImRlbGV0ZTp1c2VyIiwiZGVwbG95OmRpZ2l0YWwtY3VycmVuY3kiLCJkZXBsb3k6dG9rZW4iLCJkZXBvc2l0OmRpZ2l0YWwtY3VycmVuY3kiLCJleGVjOnRva2VuIiwiZXhlY3V0ZWhvbGQ6Y29uZmlkZW50aWFsdG9rZW4iLCJleGVjdXRlSG9sZDpkaWdpdGFsLWN1cnJlbmN5IiwiZXhlY3V0ZWhvbGQ6dG9rZW4iLCJob2xkOmNvbmZpZGVudGlhbHRva2VuIiwiaG9sZDpkaWdpdGFsLWN1cnJlbmN5IiwiaG9sZDp0b2tlbiIsIm1pbnQ6Y29uZmlkZW50aWFsdG9rZW4iLCJtaW50OmRpZ2l0YWwtY3VycmVuY3kiLCJtaW50OnRva2VuIiwicmVhZGFsbDpkaWdpdGFsLWN1cnJlbmN5LW9wZXJhdGlvbnMiLCJyZWFkX2FsbDplbnRpdHkiLCJyZWFkX2FsbDplbnRpdHk6bWVtYmVyIiwicmVhZF9hbGw6dGVuYW50IiwicmVhZDphdHRlc3RhdGlvbiIsInJlYWQ6YmFsYW5jZS1oaXN0b3J5IiwicmVhZDpjYXNoLWFjY291bnQiLCJyZWFkOmNoYW5uZWwiLCJyZWFkOmNvbmZpZGVudGlhbHRva2VuIiwicmVhZDpkYXRhIiwicmVhZDpkaWdpdGFsLWN1cnJlbmN5IiwicmVhZDpkaWdpdGFsLWN1cnJlbmN5LWhvbGRlcnMiLCJyZWFkOmRpZ2l0YWwtY3VycmVuY3ktb3BlcmF0aW9ucyIsInJlYWQ6ZW50aXR5IiwicmVhZDppbnN0cnVjdGlvbiIsInJlYWQ6bGVnYWwtZW50aXR5IiwicmVhZDpub3RpZmljYXRpb24iLCJyZWFkOm9yYWNsZSIsInJlYWQ6c2NoZW1hIiwicmVhZDp0ZW5hbnQiLCJyZWFkOnRva2VuIiwicmVhZDp1c2VyIiwicmVqZWN0Omluc3RydWN0aW9uIiwicmVsZWFzZUhvbGQ6ZGlnaXRhbC1jdXJyZW5jeSIsInNldF91cmk6dG9rZW4iLCJ0cmFuc2ZlcjpkaWdpdGFsLWN1cnJlbmN5IiwidHJhbnNmZXJGcm9tOmRpZ2l0YWwtY3VycmVuY3kiLCJ0cmFuc2Zlcjp0b2tlbiIsInVwZGF0ZV9hbGw6ZW50aXR5IiwidXBkYXRlX2FsbDplbnRpdHk6bWVtYmVyIiwidXBkYXRlX2FsbDp0ZW5hbnQiLCJ1cGRhdGU6ZGF0YSIsInVwZGF0ZTplbnRpdHkiLCJ1cGRhdGU6b3JhY2xlIiwidXBkYXRlOnRlbmFudCIsInVwZGF0ZTp1c2VyIiwid2l0aGRyYXc6ZGlnaXRhbC1jdXJyZW5jeSIsIndyaXRlOmFjY291bnQiLCJ3cml0ZTphdHRlc3RhdGlvbiIsIndyaXRlOmF6dGVjYWNjb3VudCIsIndyaXRlOmNhc2gtYWNjb3VudCIsIndyaXRlOmNoYW5uZWwiLCJ3cml0ZTpjb25maWRlbnRpYWx0b2tlbiIsIndyaXRlOmRhdGEiLCJ3cml0ZTpvcGVyYXRpb25zX3JlcXVlc3QiLCJ3cml0ZTpvcGVyYXRpb25zX3Jlc29sdmUiLCJ3cml0ZTpvcmFjbGUiLCJ3cml0ZTpzY2hlbWEiLCJ3cml0ZTp0ZW5hbnQiXX0.NVgzdUX7LkNOS0atqyTHnw9uLUclRsD4BQTN1BLoJPpjMr1bn4GL9m5obP863bLKNJKbkJ6dfEGi-dtyquNefYH9VRXF1UTC6M0mHMXx8vBAbiqL0hXOeIsT21iXroeVf2faAFGI4oYALjiJBUNfbBnPGz6Cr3g6ujNWnIUr-Fx-w2tQrh0VdywI13npufAy7fBnSwZ-13gAxCRQfuuJGuzFezIiOZJsdjOqbVTMLwzaECMiXtBexhYD2_j2XV-dgFdTlnZ_eM7S8OEEy7oro1oxp84eii0CNSK9P_LxbcP7wye_tnW0Ccx7XQniqmg6qQKb-1_lFmkOzx7QkskfMg"

		claims, err := validator.ValidateToken(ctx, token)
		assert.NoError(t, err)
		assert.Equal(t, "tenantId1:entityId1", claims.Tenant)
		assert.Contains(t, claims.Permissions, "accept:instruction")
	})
}
